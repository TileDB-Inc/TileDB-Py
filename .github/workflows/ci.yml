name: TileDB Python CI

on:
  push:
    branches: ["main", "release-*"]
    tags: ["*"]
  pull_request:
    branches: ["*"]
  workflow_dispatch:
    inputs:
      libtiledb_ref:
        description: 'TileDB branch/tag/commit to build from (optional - uses system libtiledb if not provided)'
        required: false
        type: string
      libtiledb_version:
        description: 'Version string for TileDB build (optional)'
        required: false
        type: string

concurrency:
  group: ${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

env:
  S3_BUCKET: ${{ vars.S3_BUCKET }}
  TILEDB_NAMESPACE: ${{ vars.TILEDB_NAMESPACE }}
  TILEDB_TOKEN: ${{ secrets.TILEDB_TOKEN }}

jobs:
  # Optional: build custom libtiledb if ref is specified
  build_libtiledb:
    if: inputs.libtiledb_ref != ''
    name: Build libtiledb from source
    uses: TileDB-Inc/TileDB/.github/workflows/build-artifacts.yml@main
    with:
      ref: ${{ inputs.libtiledb_ref }}
      version: ${{ inputs.libtiledb_version }}

  build:
    needs: [build_libtiledb]
    if: always() && (needs.build_libtiledb.result == 'success' || needs.build_libtiledb.result == 'skipped')
    runs-on: ${{ matrix.os }}
    defaults:
      run:
        shell: bash
    strategy:
      matrix:
        os:
          - ubuntu-latest
          - macos-15-intel
          - macos-26
          - windows-latest
        python-version: ["3.9", "3.10", "3.11", "3.12", "3.13", "3.14"]
      fail-fast: false
    env:
      MACOSX_DEPLOYMENT_TARGET: "11"
    steps:
      - name: Checkout TileDB-Py `main`
        uses: actions/checkout@v4

      - name: Setup MSVC toolset (VS 2022)
        uses: TheMrMilchmann/setup-msvc-dev@v3
        if: startsWith(matrix.os, 'windows')
        with:
          arch: x64

      - name: Install Ninja (VS 2022)
        uses: seanmiddleditch/gha-setup-ninja@v4
        if: startsWith(matrix.os, 'windows')

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Print Python version
        run: |
          which python
          which pip
          python --version

      - name: Print env
        run: printenv

      - name: Print pip debug info
        run: pip debug --verbose

      # Remove after upstream PR fully-deployed:
      # - https://github.com/actions/runner-images/pull/7125
      - name: "Install homebrew dependencies"
        run: brew install pkg-config
        if: startsWith(matrix.os, 'macos')

      - name: "Install libfaketime (Linux only)"
        if: ${{ startsWith(matrix.os, 'ubuntu') }}
        run: |
          git clone https://github.com/wolfcw/libfaketime/
          cd libfaketime
          sudo make install
          cd ..

      # Download and set up custom libtiledb if ref was specified
      - name: Determine platform for artifact
        if: inputs.libtiledb_ref != ''
        id: platform
        run: |
          if [[ "${{ matrix.os }}" == "ubuntu-latest" ]]; then
            echo "platform=linux-x86_64" >> $GITHUB_OUTPUT
          elif [[ "${{ matrix.os }}" == "macos-15-intel" ]]; then
            echo "platform=macos-x86_64" >> $GITHUB_OUTPUT
          elif [[ "${{ matrix.os }}" == "macos-26" ]]; then
            echo "platform=macos-arm64" >> $GITHUB_OUTPUT
          elif [[ "${{ matrix.os }}" == "windows-latest" ]]; then
            echo "platform=windows-x86_64" >> $GITHUB_OUTPUT
          fi

      - name: Download TileDB Core Artifact
        if: inputs.libtiledb_ref != ''
        uses: actions/download-artifact@v4
        with:
          name: release-${{ steps.platform.outputs.platform }}
          path: ${{ runner.temp }}/libtiledb-dist

      - name: Unpack libtiledb (Unix)
        if: inputs.libtiledb_ref != '' && runner.os != 'Windows'
        run: |
          cd ${{ runner.temp }}/libtiledb-dist
          tar xzf tiledb-*.tar.gz
          echo "TILEDB_PATH=${{ runner.temp }}/libtiledb-dist" >> $GITHUB_ENV
        shell: bash

      - name: Unpack libtiledb (Windows)
        if: inputs.libtiledb_ref != '' && runner.os == 'Windows'
        run: |
          $TEMP_DIR = "${{ runner.temp }}".Replace('/', '\')
          cd "$TEMP_DIR\libtiledb-dist"
          Expand-Archive -Path tiledb-*.zip -DestinationPath .
          $TILEDB_PATH = "$TEMP_DIR\libtiledb-dist".Replace('\', '/')
          echo "TILEDB_PATH=$TILEDB_PATH" >> $env:GITHUB_ENV
        shell: powershell

      - name: "Build and Install TileDB-Py"
        # We use pipx here to produce wheel/sdist to upload as artifact in case of error
        run: |
          pipx run --python ${{ matrix.python-version }} build
          WHEEL_NAME=$(ls dist/*.whl)
          pip install --verbose ${WHEEL_NAME}[test]

      - name: "Copy TileDB DLL to package (Windows)"
        if: inputs.libtiledb_ref != '' && runner.os == 'Windows'
        run: |
          $TEMP_DIR = "${{ runner.temp }}".Replace('/', '\')
          $PYTHON_VERSION = "${{ matrix.python-version }}"
          $SITE_PACKAGES = python -c "import sysconfig; print(sysconfig.get_path('purelib'))"
          Copy-Item "$TEMP_DIR\libtiledb-dist\bin\*.dll" "$SITE_PACKAGES\tiledb\" -Verbose
        shell: powershell

      - name: "Run tests"
        run: |
          PROJECT_CWD=$PWD
          rm tiledb/__init__.py
          cd /tmp
          pytest -vv --showlocals $PROJECT_CWD

      - name: "Re-run tests without pandas"
        run: |
          pip uninstall -y pandas
          pytest -vv --showlocals $PROJECT_CWD

      - name: "Print log files (failed build only)"
        run: |
          set -xeo pipefail
          # Display log files if the build failed
          echo 'Dumping log files for failed build'
          echo '----------------------------------'
          for f in $(find build -name *.log);
            do echo '------'
               echo $f
               echo '======'
               cat $f
            done;
        if: failure()

      - name: "Upload files for debug"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cibw-wheels-${{ matrix.os }}-${{ matrix.python-version }}
          path: "."
